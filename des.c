/*
 * Copyright (c) 1988 The Regents of the University of California.
 * All rights reserved.
 *
 * THIS IS UNPUBLISHED PROPRIETARY SOURCE CODE OF THE UNIVERSITY
 * OF CALIFORNIA.  The copyright notice above does not evidence
 * any actual or intended publication of this source code.
 *
 * Copying or redistribution in any form is explicitly forbidden
 * unless prior written permission is obtained from Michael Karels or an
 * authorized representative of the University of California, Berkeley.
 *
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 */

/* Some comments are adapted from an article by Matt Bishop */

extern long	E_L[8][16];
extern long	E_H[8][16];
long	keys_L[16], keys_H[16]; /* BSS */

/* These tables combine the S boxes and subsequent permutation P,
   which speeds things up slightly and eats little space. */
/* It is straightforward to combine the E, P, and S tables
   with maybe 1K extra storage for an even faster version. */
long	SP0[64] = {
0x8000820,	  0x800,	    0x20000,	      0x8020820,
0x8000000,	  0x8000820,	    0x20,	      0x8000000,
0x20020,	  0x8020000,	    0x8020820,	      0x20800,
0x8020800,	  0x20820,	    0x800,	      0x20,
0x8020000,	  0x8000020,	    0x8000800,	      0x820,
0x20800,	  0x20020,	    0x8020020,	      0x8020800,
0x820,		  0x0,		    0x0,	      0x8020020,
0x8000020,	  0x8000800,	    0x20820,	      0x20000,
0x20820,	  0x20000,	    0x8020800,	      0x800,
0x20,		  0x8020020,	    0x800,	      0x20820,
0x8000800,	  0x20,		    0x8000020,	      0x8020000,
0x8020020,	  0x8000000,	    0x20000,	      0x8000820,
0x0,		  0x8020820,	    0x20020,	      0x8000020,
0x8020000,	  0x8000800,	    0x8000820,	      0x0,
0x8020820,	  0x20800,	    0x20800,	      0x820,
0x820,		  0x20020,	    0x8000000,	      0x8020800,
};

long	SP1[64] = {
0x100000,	  0x2100001,	    0x2000401,	      0x0,
0x400,		  0x2000401,	    0x100401,	      0x2100400,
0x2100401,	  0x100000,	    0x0,	      0x2000001,
0x1,		  0x2000000,	    0x2100001,	      0x401,
0x2000400,	  0x100401,	    0x100001,	      0x2000400,
0x2000001,	  0x2100000,	    0x2100400,	      0x100001,
0x2100000,	  0x400,	    0x401,	      0x2100401,
0x100400,	  0x1,		    0x2000000,	      0x100400,
0x2000000,	  0x100400,	    0x100000,	      0x2000401,
0x2000401,	  0x2100001,	    0x2100001,	      0x1,
0x100001,	  0x2000000,	    0x2000400,	      0x100000,
0x2100400,	  0x401,	    0x100401,	      0x2100400,
0x401,		  0x2000001,	    0x2100401,	      0x2100000,
0x100400,	  0x0,		    0x1,	      0x2100401,
0x0,		  0x100401,	    0x2100000,	      0x400,
0x2000001,	  0x2000400,	    0x400,	      0x100001,
};

long	SP2[64] = {
0x10000008,	  0x10200000,	    0x2000,	      0x10202008,
0x10200000,	  0x8,		    0x10202008,	      0x200000,
0x10002000,	  0x202008,	    0x200000,	      0x10000008,
0x200008,	  0x10002000,	    0x10000000,	      0x2008,
0x0,		  0x200008,	    0x10002008,	      0x2000,
0x202000,	  0x10002008,	    0x8,	      0x10200008,
0x10200008,	  0x0,		    0x202008,	      0x10202000,
0x2008,		  0x202000,	    0x10202000,	      0x10000000,
0x10002000,	  0x8,		    0x10200008,	      0x202000,
0x10202008,	  0x200000,	    0x2008,	      0x10000008,
0x200000,	  0x10002000,	    0x10000000,	      0x2008,
0x10000008,	  0x10202008,	    0x202000,	      0x10200000,
0x202008,	  0x10202000,	    0x0,	      0x10200008,
0x8,		  0x2000,	    0x10200000,	      0x202008,
0x2000,		  0x200008,	    0x10002008,	      0x0,
0x10202000,	  0x10000000,	    0x200008,	      0x10002008,
};

long	SP3[64] = {
0x80,		  0x1040080,	    0x1040000,	      0x21000080,
0x40000,	  0x80,		    0x20000000,	      0x1040000,
0x20040080,	  0x40000,	    0x1000080,	      0x20040080,
0x21000080,	  0x21040000,	    0x40080,	      0x20000000,
0x1000000,	  0x20040000,	    0x20040000,	      0x0,
0x20000080,	  0x21040080,	    0x21040080,	      0x1000080,
0x21040000,	  0x20000080,	    0x0,	      0x21000000,
0x1040080,	  0x1000000,	    0x21000000,	      0x40080,
0x40000,	  0x21000080,	    0x80,	      0x1000000,
0x20000000,	  0x1040000,	    0x21000080,	      0x20040080,
0x1000080,	  0x20000000,	    0x21040000,	      0x1040080,
0x20040080,	  0x80,		    0x1000000,	      0x21040000,
0x21040080,	  0x40080,	    0x21000000,	      0x21040080,
0x1040000,	  0x0,		    0x20040000,	      0x21000000,
0x40080,	  0x1000080,	    0x20000080,	      0x40000,
0x0,		  0x20040000,	    0x1040080,	      0x20000080,
};

long	SP4[64] = {
0x80401000,	  0x80001040,	    0x80001040,	      0x40,
0x401040,	  0x80400040,	    0x80400000,	      0x80001000,
0x0,		  0x401000,	    0x401000,	      0x80401040,
0x80000040,	  0x0,		    0x400040,	      0x80400000,
0x80000000,	  0x1000,	    0x400000,	      0x80401000,
0x40,		  0x400000,	    0x80001000,	      0x1040,
0x80400040,	  0x80000000,	    0x1040,	      0x400040,
0x1000,		  0x401040,	    0x80401040,	      0x80000040,
0x400040,	  0x80400000,	    0x401000,	      0x80401040,
0x80000040,	  0x0,		    0x0,	      0x401000,
0x1040,		  0x400040,	    0x80400040,	      0x80000000,
0x80401000,	  0x80001040,	    0x80001040,	      0x40,
0x80401040,	  0x80000040,	    0x80000000,	      0x1000,
0x80400000,	  0x80001000,	    0x401040,	      0x80400040,
0x80001000,	  0x1040,	    0x400000,	      0x80401000,
0x40,		  0x400000,	    0x1000,	      0x401040,
};

long	SP5[64] = {
0x104,		  0x4010100,	    0x0,	      0x4010004,
0x4000100,	  0x0,		    0x10104,	      0x4000100,
0x10004,	  0x4000004,	    0x4000004,	      0x10000,
0x4010104,	  0x10004,	    0x4010000,	      0x104,
0x4000000,	  0x4,		    0x4010100,	      0x100,
0x10100,	  0x4010000,	    0x4010004,	      0x10104,
0x4000104,	  0x10100,	    0x10000,	      0x4000104,
0x4,		  0x4010104,	    0x100,	      0x4000000,
0x4010100,	  0x4000000,	    0x10004,	      0x104,
0x10000,	  0x4010100,	    0x4000100,	      0x0,
0x100,		  0x10004,	    0x4010104,	      0x4000100,
0x4000004,	  0x100,	    0x0,	      0x4010004,
0x4000104,	  0x10000,	    0x4000000,	      0x4010104,
0x4,		  0x10104,	    0x10100,	      0x4000004,
0x4010000,	  0x4000104,	    0x104,	      0x4010000,
0x10104,	  0x4,		    0x4010004,	      0x10100,
};

long	SP6[64] = {
0x40084010,	  0x40004000,	    0x4000,	      0x84010,
0x80000,	  0x10,		    0x40080010,	      0x40004010,
0x40000010,	  0x40084010,	    0x40084000,	      0x40000000,
0x40004000,	  0x80000,	    0x10,	      0x40080010,
0x84000,	  0x80010,	    0x40004010,	      0x0,
0x40000000,	  0x4000,	    0x84010,	      0x40080000,
0x80010,	  0x40000010,	    0x0,	      0x84000,
0x4010,		  0x40084000,	    0x40080000,	      0x4010,
0x0,		  0x84010,	    0x40080010,	      0x80000,
0x40004010,	  0x40080000,	    0x40084000,	      0x4000,
0x40080000,	  0x40004000,	    0x10,	      0x40084010,
0x84010,	  0x10,		    0x4000,	      0x40000000,
0x4010,		  0x40084000,	    0x80000,	      0x40000010,
0x80010,	  0x40004010,	    0x40000010,	      0x80010,
0x84000,	  0x0,		    0x40004000,	      0x4010,
0x40000000,	  0x40080010,	    0x40084010,	      0x84000,
};

long	SP7[64] = {
0x808200,	  0x0,		    0x8000,	      0x808202,
0x808002,	  0x8202,	    0x2,	      0x8000,
0x200,		  0x808200,	    0x808202,	      0x200,
0x800202,	  0x808002,	    0x800000,	      0x2,
0x202,		  0x800200,	    0x800200,	      0x8200,
0x8200,		  0x808000,	    0x808000,	      0x800202,
0x8002,		  0x800002,	    0x800002,	      0x8002,
0x0,		  0x202,	    0x8202,	      0x800000,
0x8000,		  0x808202,	    0x2,	      0x808000,
0x808200,	  0x800000,	    0x800000,	      0x200,
0x808002,	  0x8000,	    0x8200,	      0x800002,
0x200,		  0x2,		    0x800202,	      0x8202,
0x808202,	  0x8002,	    0x808000,	      0x800202,
0x800002,	  0x202,	    0x8202,	      0x808200,
0x202,		  0x800200,	    0x800200,	      0x0,
0x8002,		  0x8200,	    0x0,	      0x808002,
};

/* this code performs the DES mapping as used by the Unix password algorithm */
des(block, newblock) /* 4754 */
	long	*block;
	long	*newblock;
{
	long	otherb;
	long	*klp;
	long	*khp;
	int	i;
	register unsigned long l, h, n, m;
	register int j;
	register unsigned long b;

	otherb = block[0];
	b = block[1];

	/* the password algorithm runs salted DES 25 times */
	/* the initial permutation and its inverse are skipped:
	   the first application is null since the message is 0,
	   intermediate applications cancel each other, and
	   the final inverse is performed by ipi() */
	for (i = 0; i < 25; ++i) {
		klp = keys_L;
		khp = keys_H;

		/* this loop does one DES mapping */
		for (j = 0; j < 16; ++j) {

			/* apply E to the right half of the message */
			/* unroll the loop */
			n = b;
			m = n & 0xf;
			l = E_L[0][m];
			h = E_H[0][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[1][m];
			h |= E_H[1][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[2][m];
			h |= E_H[2][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[3][m];
			h |= E_H[3][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[4][m];
			h |= E_H[4][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[5][m];
			h |= E_H[5][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[6][m];
			h |= E_H[6][m];
			n >>= 4;
			m = n & 0xf;
			l |= E_L[7][m];
			h |= E_H[7][m];
			/* end of unrolled loop */

			/* xor in the appropriate key schedule element */
			l ^= *klp++;
			h ^= *khp++;

			/* apply the S*P transformation */
			n  = SP0[(h >> 16) & 077];
			n |= SP1[(h >> 22) & 077];
			n |= SP2[((l & 03) << 4) | ((h >> 28) & 017)];
			n |= SP3[(l >> 2) & 077];
			n |= SP4[(l >> 8) & 077];
			n |= SP5[(l >> 14) & 077];
			n |= SP6[(l >> 20) & 077];
			n |= SP7[(l >> 26) & 077];

			/* xor the right half into the left and swap halves */
			h = otherb;
			otherb = b;
			b = n ^ h;

		}

		/* swap halves */
		n = otherb;
		otherb = b;
		b = n;
	}

	/* save the result */
	newblock[0] = otherb;
	newblock[1] = b;
}

long  ipi_L0[16] = {
0x0,		  0x1000000,	    0x10000,	      0x1010000,
0x100,		  0x1000100,	    0x10100,	      0x1010100,
0x1,		  0x1000001,	    0x10001,	      0x1010001,
0x101,		  0x1000101,	    0x10101,	      0x1010101,
};

long  ipi_L2[16] = {
0x0,		  0x4000000,	    0x40000,	      0x4040000,
0x400,		  0x4000400,	    0x40400,	      0x4040400,
0x4,		  0x4000004,	    0x40004,	      0x4040004,
0x404,		  0x4000404,	    0x40404,	      0x4040404,
};

long  ipi_L4[16] = {
0x0,		  0x10000000,	    0x100000,	      0x10100000,
0x1000,		  0x10001000,	    0x101000,	      0x10101000,
0x10,		  0x10000010,	    0x100010,	      0x10100010,
0x1010,		  0x10001010,	    0x101010,	      0x10101010,
};

long  ipi_L6[16] = {
0x0,		  0x40000000,	    0x400000,	      0x40400000,
0x4000,		  0x40004000,	    0x404000,	      0x40404000,
0x40,		  0x40000040,	    0x400040,	      0x40400040,
0x4040,		  0x40004040,	    0x404040,	      0x40404040,
};

long  ipi_L8[16] = {
0x0,		  0x2000000,	    0x20000,	      0x2020000,
0x200,		  0x2000200,	    0x20200,	      0x2020200,
0x2,		  0x2000002,	    0x20002,	      0x2020002,
0x202,		  0x2000202,	    0x20202,	      0x2020202,
};

long  ipi_La[16] = {
0x0,		  0x8000000,	    0x80000,	      0x8080000,
0x800,		  0x8000800,	    0x80800,	      0x8080800,
0x8,		  0x8000008,	    0x80008,	      0x8080008,
0x808,		  0x8000808,	    0x80808,	      0x8080808,
};

long  ipi_Lc[16] = {
0x0,		  0x20000000,	    0x200000,	      0x20200000,
0x2000,		  0x20002000,	    0x202000,	      0x20202000,
0x20,		  0x20000020,	    0x200020,	      0x20200020,
0x2020,		  0x20002020,	    0x202020,	      0x20202020,
};

long  ipi_Le[16] = {
0x0,		  0x80000000,	    0x800000,	      0x80800000,
0x8000,		  0x80008000,	    0x808000,	      0x80808000,
0x80,		  0x80000080,	    0x800080,	      0x80800080,
0x8080,		  0x80008080,	    0x808080,	      0x80808080,
};

long  ipi_H1[16] = {
0x0,		  0x1000000,	    0x10000,	      0x1010000,
0x100,		  0x1000100,	    0x10100,	      0x1010100,
0x1,		  0x1000001,	    0x10001,	      0x1010001,
0x101,		  0x1000101,	    0x10101,	      0x1010101,
};

long  ipi_H3[16] = {
0x0,		  0x4000000,	    0x40000,	      0x4040000,
0x400,		  0x4000400,	    0x40400,	      0x4040400,
0x4,		  0x4000004,	    0x40004,	      0x4040004,
0x404,		  0x4000404,	    0x40404,	      0x4040404,
};

long  ipi_H5[16] = {
0x0,		  0x10000000,	    0x100000,	      0x10100000,
0x1000,		  0x10001000,	    0x101000,	      0x10101000,
0x10,		  0x10000010,	    0x100010,	      0x10100010,
0x1010,		  0x10001010,	    0x101010,	      0x10101010,
};

long  ipi_H7[16] = {
0x0,		  0x40000000,	    0x400000,	      0x40400000,
0x4000,		  0x40004000,	    0x404000,	      0x40404000,
0x40,		  0x40000040,	    0x400040,	      0x40400040,
0x4040,		  0x40004040,	    0x404040,	      0x40404040,
};

long  ipi_H9[16] = {
0x0,		  0x2000000,	    0x20000,	      0x2020000,
0x200,		  0x2000200,	    0x20200,	      0x2020200,
0x2,		  0x2000002,	    0x20002,	      0x2020002,
0x202,		  0x2000202,	    0x20202,	      0x2020202,
};

long  ipi_Hb[16] = {
0x0,		  0x8000000,	    0x80000,	      0x8080000,
0x800,		  0x8000800,	    0x80800,	      0x8080800,
0x8,		  0x8000008,	    0x80008,	      0x8080008,
0x808,		  0x8000808,	    0x80808,	      0x8080808,
};

long  ipi_Hd[16] = {
0x0,		  0x20000000,	    0x200000,	      0x20200000,
0x2000,		  0x20002000,	    0x202000,	      0x20202000,
0x20,		  0x20000020,	    0x200020,	      0x20200020,
0x2020,		  0x20002020,	    0x202020,	      0x20202020,
};

long  ipi_Hf[16] = {
0x0,		  0x80000000,	    0x800000,	      0x80800000,
0x8000,		  0x80008000,	    0x808000,	      0x80808000,
0x80,		  0x80000080,	    0x800080,	      0x80800080,
0x8080,		  0x80008080,	    0x808080,	      0x80808080,
};

/* apply the final permutation (initial permutation inverted) */
ipi(block, newblock) /* 4930 */
	long *block, *newblock;
{
	register unsigned long l, h;
	register unsigned long b;

	/* more unrolled loops */
	b = block[0];
	l = ipi_L0[b & 0xf];
	b >>= 4;
	h = ipi_H1[b & 0xf];
	b >>= 4;
	l |= ipi_L2[b & 0xf];
	b >>= 4;
	h |= ipi_H3[b & 0xf];
	b >>= 4;
	l |= ipi_L4[b & 0xf];
	b >>= 4;
	h |= ipi_H5[b & 0xf];
	b >>= 4;
	l |= ipi_L6[b & 0xf];
	b >>= 4;
	h |= ipi_H7[b & 0xf];

	b = block[1];
	l |= ipi_L8[b & 0xf];
	b >>= 4;
	h |= ipi_H9[b & 0xf];
	b >>= 4;
	l |= ipi_La[b & 0xf];
	b >>= 4;
	h |= ipi_Hb[b & 0xf];
	b >>= 4;
	l |= ipi_Lc[b & 0xf];
	b >>= 4;
	h |= ipi_Hd[b & 0xf];
	b >>= 4;
	l |= ipi_Le[b & 0xf];
	b >>= 4;
	h |= ipi_Hf[b & 0xf];

	newblock[0] = l;
	newblock[1] = h;
}

/* end of worm code */
